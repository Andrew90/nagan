//---------------------------------------------------------------------------

#include <vcl.h>
#pragma hdrstop

#include "Settings.h"
//---------------------------------------------------------------------------
#pragma package(smart_init)
#pragma resource "*.dfm"

#include "Global.h"


TSettingsForm *SettingsForm;
//---------------------------------------------------------------------------
__fastcall TSettingsForm::TSettingsForm(TComponent* Owner)
	: TForm(Owner)
{
}
//---------------------------------------------------------------------------
void __fastcall TSettingsForm::FormCreate(TObject *Sender)
{
	KeyPreview=true;
}
//---------------------------------------------------------------------------
void __fastcall TSettingsForm::FormShow(TObject *Sender)
{
	ini = new TIniFile(Globals::IniFileName);
	names = new TStringList();
	SelRow=1;
	SelCol=1;
// ищем типоразмеры в файле и добавляем их в ComboBox
	UpdateComboBox();
// если типоразмеров не найдено, заполняем имена настроек
//	if (cbTypeSize->Text=="")
//	{
		names->Add("Diameter");
		names->Add("ThicknessBorder1");
		names->Add("ThicknessBorder2");
		names->Add("Min_Good_Length");
		names->Add("ThicknessDeadZoneStart");
		names->Add("ThicknessDeadZoneFinish");
		names->Add("MinThickness");
		names->Add("MaxThickness");
		names->Add("InSpeed");
		names->Add("WorkSpeed");
		names->Add("OutSpeed");

		names->Add("NominThickness");
		names->Add("CutLeftBorderACF");
		names->Add("CutRightBorderACF");

		for(int i = 1; i <= 6; ++i)
		{
		   names->Add("MinEnergy"+ IntToStr(i));
		   names->Add("MaxEnergy"+ IntToStr(i));
		   names->Add("FirstPeakPerEnergy" + IntToStr(i));
		}
//	}
//	else
//		ini->ReadSection("Type_" + cbTypeSize->Text,names);
// создаем строки с заполненными полями:  "имя настройки" - "текущее значение"
	cbTypeSizeSelect(Sender);
	this->bDeleteTypeSize->Enabled = true;
	this->cbTypeSize->Enabled = true;
	this->bCreateTypeSize->Caption = "Создать";
	StatusBarBottom->Panels->Items[0]->Text="";
}
//---------------------------------------------------------------------------

void __fastcall TSettingsForm::FormClose(TObject *Sender, TCloseAction &Action)
{
// при закрытии формы текущий типоразмер становится текущим для всех
	Globals::typesize.setTypesize(cbTypeSize->Text);
}
//---------------------------------------------------------------------------

void TSettingsForm::UpdateComboBox()
{
// очищаем весь список элементов ComboBox
	cbTypeSize->Items->Clear();
	TStringList *sections = new TStringList();
	ini->ReadSections(sections);
// добавляем в список элементов те элементы из ini файла, которые характеризуют типоразмер (префикс "Type_")
	for (int i = 0; i < sections->Count; i++)
		if (sections->Strings[i].SubString(1,5) == "Type_")
			cbTypeSize->AddItem(sections->Strings[i].SubString(6,20),NULL);

	cbTypeSize->ItemIndex = cbTypeSize->Items->IndexOf(Globals::typesize.name);
	sections->~TStringList();
}
//---------------------------------------------------------------------------

void __fastcall TSettingsForm::ValueListKeyPress(TObject *Sender, wchar_t &Key)
{
// ловим нажатие на клавишу
	switch (Key)
	{
		case VK_F1:
			WinExec("hh Help.chm::Settings.htm",SW_RESTORE);
			break;
   		case 27:
			SettingsForm->Close();
			break;
		case '\r':
		// нажатие на Enter только внутри объекта ValueListEditor
			if (Sender==ValueListEditor)
			{
				if ( ValueListEditor->Cells[SelCol][SelRow].IsEmpty() )
				{
					StatusBarBottom->Panels->Items[0]->Text="Введите значение!";
					break;
				}
				else
				{
					if (bCreateTypeSize->Caption=="Создать")
					{  // исправляем значения только у существующего типоразмера
						try
						{
							ValueListEditor->Cells[SelCol][SelRow].ToDouble();
						}
						catch (EConvertError &e)
						{
							e.Message="Fuck";
							StatusBarBottom->Panels->Items[0]->Text="Неправильное значение!";
							break;
						}
						ini->WriteString( "Type_" + cbTypeSize->Text,names->Strings[SelRow-1],ValueListEditor->Cells[SelCol][SelRow]);
						StatusBarBottom->Panels->Items[0]->Text="Значение изменено.";
						break;
					}
				}
			}
	}
}
//---------------------------------------------------------------------------

void __fastcall TSettingsForm::ValueListEditorSelectCell(TObject *Sender, int ACol,
          int ARow, bool &CanSelect)
{
// сохраняем адрес выделенной ячейки в private переменных.
	SelRow=ARow;
	SelCol=ACol;
	//StatusBarBottom->Panels->Items[1]->Text="Столбец " +IntToStr(SelCol)+", Ряд "+IntToStr(SelRow);
	//this->StatusBarBottom->Refresh();
}
//---------------------------------------------------------------------------

void __fastcall TSettingsForm::bCreateTypeSizeClick(TObject *Sender)
{
// пользователь пытается создать типоразмер

	if (bCreateTypeSize->Caption=="Создать")
	{
		ValueListEditor->InsertRow("Название типоразмера","",false);
	 //	for (int i = 1; i < ValueListEditor->RowCount; i++)
		 //	ValueListEditor->Cells[1][i]="";
// даём возможность выбора диаметра только из предложенных значений
		ValueListEditor->ItemProps[1]->EditStyle=esPickList;
		ValueListEditor->ItemProps[1]->PickList->Add("60");
		ValueListEditor->ItemProps[1]->PickList->Add("73");
		ValueListEditor->ItemProps[1]->PickList->Add("89");
		this->cbTypeSize->Enabled=false;
		this->bDeleteTypeSize->Enabled = false;
		bCreateTypeSize->Caption="Подтвердить";
	}

	else

	if (bCreateTypeSize->Caption=="Подтвердить")
	{
		String Sect = "Type_" + ValueListEditor->Cells[1][1];
		bool ok_ts=true;
// проверяем, все ли норм значения ввел юзер
		try
		{
			for(int i=0; i < names->Count; i++)
				double tmp = ValueListEditor->Cells[1][i + 2].ToDouble();
		}
		catch (EConvertError &e)
		{
			e.Message="Fuck";
			StatusBarBottom->Panels->Items[0]->Text="Неправильное значение!";
			ok_ts=false;
		}

		if (ok_ts)
		{
			for(int i=0; i < names->Count; i++)
			{
				double tmp = ValueListEditor->Cells[1][i+2].ToDouble();
				ini->WriteFloat(Sect, names->Strings[i] , tmp);
			}
			Globals::typesize.setTypesize( ValueListEditor->Cells[1][1] );
			ValueListEditor->DeleteRow(1);
			bCreateTypeSize->Caption = "Создать";
			this->cbTypeSize->Enabled = true;
			this->bDeleteTypeSize->Enabled = true;
			StatusBarBottom->Panels->Items[0]->Text = "Типоразмер создан.";
			UpdateComboBox();
			cbTypeSizeSelect(Sender);
		}
	}
}
//---------------------------------------------------------------------------

void __fastcall TSettingsForm::bDeleteTypeSizeClick(TObject *Sender)
{
// пользователь пытается удалить типоразмер
	if ( Application->MessageBoxW(L"Вы точно хотите удалить типоразмер?",L"Сообщение",MB_YESNO) == 6 )
	{
		ini->EraseSection("Type_"+cbTypeSize->Text);
		this->StatusBarBottom->Panels->Items[0]->Text="Типоразмер удален.";
		if (Globals::typesize.name == cbTypeSize->Text)
		{
			String st0 = cbTypeSize->Items->Strings[0];
			String st1 = cbTypeSize->Items->Strings[1];
			Globals::typesize.setTypesize( (cbTypeSize->ItemIndex==0) ? (st1) : (st0) );
		}
		UpdateComboBox();
		cbTypeSizeSelect(Sender);
	}
}
//---------------------------------------------------------------------------

void __fastcall TSettingsForm::cbTypeSizeSelect(TObject *Sender)
{
// изменился типоразмер - нужно показать его настройки. удаляем все поля и заполняем заново
	ValueListEditor->Strings->Clear();
	String sect = "Type_"+cbTypeSize->Text;
	try
	{
		ValueListEditor->InsertRow("Диаметр трубы, мм",ini->ReadInteger(sect,"Diameter",0),true);
		ValueListEditor->ItemProps[0]->ReadOnly = true;

		ValueListEditor->InsertRow("Толщинометрия: порог брака",ini->ReadFloat(sect,"ThicknessBorder1",0.0),true);
		ValueListEditor->InsertRow("Толщинометрия: порог класса 2",ini->ReadFloat(sect,"ThicknessBorder2",0.0),true);
		ValueListEditor->InsertRow("Минимальный годный участок",ini->ReadInteger(sect,"Min_Good_Length",0),true);

		ValueListEditor->InsertRow("Мёртвая зона толщиномера, начало",ini->ReadInteger(sect,"ThicknessDeadZoneStart",0),true);
		ValueListEditor->InsertRow("Мёртвая зона толщиномера, конец",ini->ReadInteger(sect,"ThicknessDeadZoneFinish",0),true);
		ValueListEditor->InsertRow("Минимальная толщина, мм",ini->ReadFloat(sect,"MinThickness",2),true);
		ValueListEditor->InsertRow("Максимальная толщина, мм",ini->ReadFloat(sect,"MaxThickness",9),true);

		ValueListEditor->InsertRow("Скорость вращения на входе",ini->ReadInteger(sect,"InSpeed",0),true);
		ValueListEditor->ItemProps[8]->ReadOnly = true;
		ValueListEditor->ItemProps[8]->EditStyle=esPickList;
		ValueListEditor->ItemProps[8]->PickList->AddStrings(Globals::typesize.getSpeedNames());
		ValueListEditor->InsertRow("Скорость вращения в работе",ini->ReadInteger(sect,"WorkSpeed",0),true);
		ValueListEditor->ItemProps[9]->ReadOnly = true;
		ValueListEditor->ItemProps[9]->EditStyle=esPickList;
		ValueListEditor->ItemProps[9]->PickList->AddStrings(Globals::typesize.getSpeedNames());
		ValueListEditor->InsertRow("Скорость вращения на выходе",ini->ReadInteger(sect,"OutSpeed",0),true);
		ValueListEditor->ItemProps[10]->ReadOnly = true;
		ValueListEditor->ItemProps[10]->EditStyle=esPickList;
		ValueListEditor->ItemProps[10]->PickList->AddStrings(Globals::typesize.getSpeedNames());

        ValueListEditor->InsertRow("Номинальная толщина",ini->ReadFloat(sect,"NominThickness",5),true);

		  ValueListEditor->InsertRow("Отсечение левой границы АЧХ",ini->ReadInteger(sect,"CutLeftBorderACF",30),true);
		  ValueListEditor->InsertRow("Отсечение правой границы АЧХ",ini->ReadInteger(sect,"CutRightBorderACF",80),true);

		for(int i = 0; i < 6; ++i)
		{
		 UnicodeString s = IntToStr(1 + i);
			ValueListEditor->InsertRow(
			"Датчик " + s +  " минимальная энергия"
			,ini->ReadFloat(sect
			, "MinEnergy" + s
			,0.1),true);

			ValueListEditor->InsertRow(
			"Датчик " + s +  " максимальная энергия"
			,ini->ReadFloat(sect
			, "MaxEnergy" + s
			,200),true);

			ValueListEditor->InsertRow(
			"Датчик " + s + " отношение первого пика к энергии"
			,ini->ReadFloat(sect
			, "FirstPeakPerEnergy" + s
			,0.3),true);
		}

	}
	catch (EConvertError &e)
	{
		e.Message="Fuck";
		StatusBarBottom->Panels->Items[0]->Text="Файл настроек поврежден";   // не работает!!!
		StatusBarBottom->Refresh();
	}
}
//---------------------------------------------------------------------------

